<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShieldPost â€” Analytics Dashboard</title>
    <meta name="description" content="AI spam moderation analytics dashboard">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ›¡ï¸</text></svg>">
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
</head>

<body>

    <div class="app-layout">

        <!-- â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <aside class="sidebar">
            <a href="/" class="sidebar-brand">
                <span class="brand-icon">ğŸ›¡ï¸</span>
                <span class="brand-text">ShieldPost</span>
            </a>
            <nav class="sidebar-nav">
                <a href="/" class="nav-item">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-label">Feed</span>
                </a>
                <a href="/dashboard" class="nav-item active">
                    <span class="nav-icon">ğŸ“Š</span>
                    <span class="nav-label">Dashboard</span>
                </a>
                <a href="/" class="nav-item">
                    <span class="nav-icon">â•</span>
                    <span class="nav-label">Create</span>
                </a>
                <a href="/dashboard" class="nav-item">
                    <span class="nav-icon">ğŸ””</span>
                    <span class="nav-label">Activity</span>
                </a>
                <a href="/dashboard" class="nav-item">
                    <span class="nav-icon">âš™ï¸</span>
                    <span class="nav-label">Settings</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-avatar">M</div>
                <div class="user-info">
                    <div class="user-name">Moderator</div>
                    <div class="user-role">AI Admin</div>
                </div>
            </div>
        </aside>

        <!-- â”€â”€ Main Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <main class="main-content">
            <div class="dashboard-layout">

                <div class="page-header">
                    <h1>Moderation Dashboard</h1>
                    <p>Real-time analytics for AI spam detection</p>
                </div>

                <!-- Stats Row -->
                <div class="stats-row">
                    <div class="stat-card accent">
                        <div class="stat-header">
                            <div class="stat-icon">ğŸ’¬</div>
                        </div>
                        <div class="stat-value" id="statTotal">0</div>
                        <div class="stat-label">Total Comments</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-header">
                            <div class="stat-icon">ğŸš«</div>
                        </div>
                        <div class="stat-value" id="statSpam">0</div>
                        <div class="stat-label">Spam Detected</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-header">
                            <div class="stat-icon">âœ…</div>
                        </div>
                        <div class="stat-value" id="statLegit">0</div>
                        <div class="stat-label">Legitimate</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-header">
                            <div class="stat-icon">ğŸ“ˆ</div>
                        </div>
                        <div class="stat-value" id="statPercent">0%</div>
                        <div class="stat-label">Spam Rate</div>
                    </div>
                </div>

                <!-- Threshold Settings -->
                <div class="settings-card">
                    <h3>âš™ï¸ Auto-Hide Threshold</h3>
                    <p class="settings-desc">Comments with spam probability above this value are automatically hidden.
                    </p>
                    <div class="threshold-control">
                        <span class="label-text">Lenient</span>
                        <input type="range" class="threshold-slider" id="thresholdSlider" min="0.1" max="0.99"
                            step="0.01" value="0.5">
                        <span class="label-text">Strict</span>
                        <span class="threshold-value" id="thresholdValue">50%</span>
                        <button class="btn btn-primary btn-sm" id="saveThresholdBtn">Save</button>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts-row">
                    <div class="chart-card">
                        <div class="chart-card-header">
                            <h3>ğŸ¥§ Spam vs Legitimate</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-card-header">
                            <h3>ğŸ”‘ Top Spam Keywords</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="keywordsChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="charts-row">
                    <div class="chart-card full-width">
                        <div class="chart-card-header">
                            <h3>ğŸ“ˆ Confidence Distribution</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="confidenceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="empty-state" id="dashboardEmpty" style="display: none;">
                    <div class="empty-icon">ğŸ“Š</div>
                    <h3>No data yet</h3>
                    <p>Go to the <a href="/" style="color: var(--accent);">Feed</a> and add some comments to see
                        analytics.</p>
                </div>

            </div>
        </main>

    </div>

    <!-- Mobile Bottom Nav -->
    <nav class="mobile-nav">
        <a href="/">ğŸ </a>
        <a href="/dashboard" class="active">ğŸ“Š</a>
        <a href="/">â•</a>
        <a href="/dashboard">ğŸ””</a>
        <a href="/dashboard">âš™ï¸</a>
    </nav>

    <script>
        const API = '';
        let pieChart, keywordsChart, confidenceChart;

        // â”€â”€ Threshold â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadThreshold() {
            try {
                const res = await fetch(`${API}/api/settings`);
                const data = await res.json();
                document.getElementById('thresholdSlider').value = data.threshold;
                document.getElementById('thresholdValue').textContent = Math.round(data.threshold * 100) + '%';
            } catch (e) { }
        }

        document.getElementById('thresholdSlider').addEventListener('input', e => {
            document.getElementById('thresholdValue').textContent = Math.round(e.target.value * 100) + '%';
        });

        document.getElementById('saveThresholdBtn').addEventListener('click', async () => {
            const val = parseFloat(document.getElementById('thresholdSlider').value);
            try {
                await fetch(`${API}/api/settings/threshold`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ threshold: val }),
                });
                showToast('Threshold updated', 'success');
            } catch (e) {
                showToast('Failed to update', 'error');
            }
        });

        function showToast(msg, type = 'info') {
            const el = document.createElement('div');
            el.className = `toast toast-${type}`;
            el.textContent = msg;
            document.body.appendChild(Object.assign(document.createElement('div'), {
                innerHTML: `<div class="toast-container" style="position:fixed;top:20px;right:20px;z-index:10000"><div class="toast toast-${type}">${msg}</div></div>`
            })).remove;
            const container = document.createElement('div');
            container.style.cssText = 'position:fixed;top:20px;right:20px;z-index:10000;';
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = msg;
            container.appendChild(toast);
            document.body.appendChild(container);
            setTimeout(() => container.remove(), 3000);
        }

        // â”€â”€ Dashboard Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadDashboard() {
            try {
                const res = await fetch(`${API}/api/analytics`);
                const data = await res.json();

                if (data.total === 0) {
                    document.getElementById('dashboardEmpty').style.display = 'block';
                    return;
                }
                document.getElementById('dashboardEmpty').style.display = 'none';

                // Animate stat counters
                animateValue('statTotal', data.total);
                animateValue('statSpam', data.spam);
                animateValue('statLegit', data.legit);
                document.getElementById('statPercent').textContent = data.spam_percentage + '%';

                renderPieChart(data.spam, data.legit);
                renderKeywordsChart(data.top_keywords);
                renderConfidenceChart(data.confidences);
            } catch (e) {
                console.error('Dashboard error:', e);
            }
        }

        function animateValue(id, end) {
            const el = document.getElementById(id);
            const start = parseInt(el.textContent) || 0;
            if (start === end) return;
            const duration = 600;
            const startTime = performance.now();
            function update(now) {
                const progress = Math.min((now - startTime) / duration, 1);
                const ease = 1 - Math.pow(1 - progress, 3);
                el.textContent = Math.round(start + (end - start) * ease);
                if (progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }

        function chartColors() {
            return {
                text: '#a0a0a0',
                grid: 'rgba(255,255,255,0.04)',
                font: { family: 'Inter' },
            };
        }

        function renderPieChart(spam, legit) {
            const ctx = document.getElementById('pieChart').getContext('2d');
            if (pieChart) pieChart.destroy();
            const c = chartColors();
            pieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Spam', 'Legitimate'],
                    datasets: [{
                        data: [spam, legit],
                        backgroundColor: ['rgba(239,68,68,0.8)', 'rgba(34,197,94,0.8)'],
                        borderColor: ['#ef4444', '#22c55e'],
                        borderWidth: 2,
                        hoverOffset: 6,
                    }],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: c.text, font: { ...c.font, size: 12 }, padding: 16 },
                        },
                    },
                },
            });
        }

        function renderKeywordsChart(keywords) {
            const ctx = document.getElementById('keywordsChart').getContext('2d');
            if (keywordsChart) keywordsChart.destroy();
            if (!keywords || keywords.length === 0) return;
            const c = chartColors();

            keywordsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: keywords.map(k => k.word),
                    datasets: [{
                        data: keywords.map(k => k.count),
                        backgroundColor: 'rgba(139, 92, 246, 0.5)',
                        borderColor: '#8b5cf6',
                        borderWidth: 1,
                        borderRadius: 4,
                    }],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: c.text, font: c.font }, grid: { color: c.grid } },
                        y: { ticks: { color: '#c4b5fd', font: { ...c.font, size: 11 } }, grid: { display: false } },
                    },
                },
            });
        }

        function renderConfidenceChart(confidences) {
            const ctx = document.getElementById('confidenceChart').getContext('2d');
            if (confidenceChart) confidenceChart.destroy();
            if (!confidences || confidences.length === 0) return;
            const c = chartColors();

            const bins = Array(20).fill(0);
            confidences.forEach(v => { bins[Math.min(Math.floor(v * 20), 19)]++; });
            const labels = bins.map((_, i) => `${i * 5}-${(i + 1) * 5}%`);

            confidenceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        data: bins,
                        backgroundColor: bins.map((_, i) => i >= 10 ? 'rgba(239,68,68,0.5)' : 'rgba(34,197,94,0.5)'),
                        borderColor: bins.map((_, i) => i >= 10 ? '#ef4444' : '#22c55e'),
                        borderWidth: 1,
                        borderRadius: 3,
                    }],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: c.text, font: { ...c.font, size: 9 }, maxRotation: 45 }, grid: { color: c.grid } },
                        y: { ticks: { color: c.text, font: c.font }, grid: { color: c.grid } },
                    },
                },
            });
        }

        loadThreshold();
        loadDashboard();
        setInterval(loadDashboard, 10000);
    </script>
</body>

</html>