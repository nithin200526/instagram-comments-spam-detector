<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShieldPost â€” Analytics Dashboard</title>
    <meta name="description" content="AI spam moderation analytics and settings">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ›¡ï¸</text></svg>">
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
</head>

<body>

    <div class="app">

        <!-- â•â•â• Sidebar â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <aside class="sidebar">
            <a href="/" class="brand">
                <span class="brand-logo">ğŸ›¡ï¸</span>
                <span class="brand-name">ShieldPost</span>
            </a>
            <nav class="nav">
                <a href="/" class="nav-link">
                    <span class="icon">ğŸ </span><span class="label">Feed</span>
                </a>
                <a href="/dashboard" class="nav-link active">
                    <span class="icon">ğŸ“Š</span><span class="label">Analytics</span>
                </a>
                <a href="/" class="nav-link">
                    <span class="icon">â•</span><span class="label">Create</span>
                </a>
                <a href="/dashboard" class="nav-link">
                    <span class="icon">ğŸ””</span><span class="label">Activity</span>
                </a>
                <a href="/dashboard" class="nav-link">
                    <span class="icon">âš™ï¸</span><span class="label">Settings</span>
                </a>
            </nav>
            <div class="profile-card">
                <div class="profile-avatar">M</div>
                <div>
                    <div class="profile-name">Moderator</div>
                    <div class="profile-role">AI Admin</div>
                </div>
            </div>
        </aside>

        <!-- â•â•â• Main â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <main class="main">
            <div class="dash-container">

                <div class="page-title">
                    <h1>ğŸ“Š Moderation Dashboard</h1>
                    <p>Real-time AI spam detection analytics &amp; settings</p>
                </div>

                <!-- Stats Grid (6 cards) -->
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat s-accent">
                        <div class="stat-icon">ğŸ’¬</div>
                        <div class="stat-val" id="stTotal">0</div>
                        <div class="stat-lbl">Total Comments</div>
                    </div>
                    <div class="stat s-red">
                        <div class="stat-icon">ğŸš«</div>
                        <div class="stat-val" id="stSpam">0</div>
                        <div class="stat-lbl">Spam Detected</div>
                    </div>
                    <div class="stat s-green">
                        <div class="stat-icon">âœ…</div>
                        <div class="stat-val" id="stLegit">0</div>
                        <div class="stat-lbl">Legitimate</div>
                    </div>
                    <div class="stat s-blue">
                        <div class="stat-icon">ğŸ“ˆ</div>
                        <div class="stat-val" id="stRate">0%</div>
                        <div class="stat-lbl">Spam Rate</div>
                    </div>
                    <div class="stat s-yellow">
                        <div class="stat-icon">ğŸ“</div>
                        <div class="stat-val" id="stPosts">0</div>
                        <div class="stat-lbl">Total Posts</div>
                    </div>
                    <div class="stat s-purple">
                        <div class="stat-icon">â¤ï¸</div>
                        <div class="stat-val" id="stLikes">0</div>
                        <div class="stat-lbl">Total Likes</div>
                    </div>
                </div>

                <!-- Threshold Settings -->
                <div class="settings-box">
                    <h3>âš™ï¸ Auto-Hide Threshold</h3>
                    <p class="desc">Comments with spam probability above this value are automatically hidden by the AI.
                    </p>
                    <div class="threshold-row">
                        <span class="t-label">Lenient</span>
                        <input type="range" class="threshold-slider" id="thSlider" min="0.1" max="0.99" step="0.01"
                            value="0.5">
                        <span class="t-label">Strict</span>
                        <span class="t-value" id="thValue">50%</span>
                        <button class="btn btn-primary btn-sm" id="thSaveBtn">Save</button>
                    </div>
                </div>

                <!-- Charts: 2-column -->
                <div class="chart-grid">
                    <div class="chart-box">
                        <h3>ğŸ¥§ Spam vs Legitimate</h3>
                        <div class="chart-area"><canvas id="pieChart"></canvas></div>
                    </div>
                    <div class="chart-box">
                        <h3>ğŸ”‘ Top Spam Keywords</h3>
                        <div class="chart-area"><canvas id="kwChart"></canvas></div>
                    </div>
                </div>

                <!-- Confidence Histogram -->
                <div class="chart-grid">
                    <div class="chart-box full">
                        <h3>ğŸ“ˆ Confidence Distribution</h3>
                        <div class="chart-area"><canvas id="confChart"></canvas></div>
                    </div>
                </div>

                <!-- Activity Log -->
                <div class="activity-box">
                    <h3>ğŸ•‘ Recent Moderation Activity</h3>
                    <div class="activity-list" id="activityList">
                        <div class="empty" style="padding:24px">
                            <p>No activity yet</p>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Mobile Nav -->
    <nav class="mob-nav">
        <a href="/">ğŸ </a>
        <a href="/dashboard" class="active">ğŸ“Š</a>
        <a href="/">â•</a>
        <a href="/dashboard">ğŸ””</a>
        <a href="/dashboard">âš™ï¸</a>
    </nav>

    <!-- Toasts -->
    <div class="toasts" id="toasts"></div>

    <script>
        const API = '';
        let pieChart, kwChart, confChart;

        // â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function toast(msg, type = 'info') {
            const el = document.createElement('div');
            el.className = `toast toast-${type}`;
            el.textContent = msg;
            document.getElementById('toasts').appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        // â”€â”€ Threshold â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadThreshold() {
            try {
                const r = await fetch(`${API}/api/settings`);
                const d = await r.json();
                document.getElementById('thSlider').value = d.threshold;
                document.getElementById('thValue').textContent = Math.round(d.threshold * 100) + '%';
            } catch (e) { }
        }

        document.getElementById('thSlider').addEventListener('input', e => {
            document.getElementById('thValue').textContent = Math.round(e.target.value * 100) + '%';
        });

        document.getElementById('thSaveBtn').addEventListener('click', async () => {
            try {
                await fetch(`${API}/api/settings/threshold`, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ threshold: parseFloat(document.getElementById('thSlider').value) }),
                });
                toast('Threshold updated', 'ok');
            } catch (e) { toast('Failed to update', 'err'); }
        });

        // â”€â”€ Dashboard Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadDash() {
            try {
                const r = await fetch(`${API}/api/analytics`);
                const d = await r.json();

                animVal('stTotal', d.total);
                animVal('stSpam', d.spam);
                animVal('stLegit', d.legit);
                animVal('stPosts', d.total_posts || 0);
                animVal('stLikes', d.total_likes || 0);
                document.getElementById('stRate').textContent = d.spam_percentage + '%';

                renderPie(d.spam, d.legit);
                renderKW(d.top_keywords);
                renderConf(d.confidences);
                renderActivity(d.recent_activity || []);
            } catch (e) { console.error('Dash error:', e); }
        }

        function animVal(id, end) {
            const el = document.getElementById(id);
            const start = parseInt(el.textContent) || 0;
            if (start === end) return;
            const t0 = performance.now();
            (function tick(now) {
                const p = Math.min((now - t0) / 600, 1);
                const ease = 1 - Math.pow(1 - p, 3);
                el.textContent = Math.round(start + (end - start) * ease);
                if (p < 1) requestAnimationFrame(tick);
            })(t0);
        }

        const cConf = () => ({ text: '#a0a0a0', grid: 'rgba(255,255,255,0.04)', font: { family: 'Inter' } });

        function renderPie(spam, legit) {
            const ctx = document.getElementById('pieChart');
            if (pieChart) pieChart.destroy();
            const c = cConf();
            pieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Spam', 'Legitimate'],
                    datasets: [{
                        data: [spam, legit],
                        backgroundColor: ['rgba(239,68,68,0.75)', 'rgba(34,197,94,0.75)'],
                        borderColor: ['#ef4444', '#22c55e'], borderWidth: 2, hoverOffset: 6
                    }],
                },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '62%',
                    plugins: { legend: { position: 'bottom', labels: { color: c.text, font: { ...c.font, size: 12 }, padding: 16 } } }
                },
            });
        }

        function renderKW(kws) {
            const ctx = document.getElementById('kwChart');
            if (kwChart) kwChart.destroy();
            if (!kws || !kws.length) return;
            const c = cConf();
            kwChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: kws.map(k => k.word), datasets: [{
                        data: kws.map(k => k.count),
                        backgroundColor: 'rgba(139,92,246,0.45)', borderColor: '#8b5cf6', borderWidth: 1, borderRadius: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: c.text, font: c.font }, grid: { color: c.grid } },
                        y: { ticks: { color: '#c4b5fd', font: { ...c.font, size: 11 } }, grid: { display: false } }
                    }
                },
            });
        }

        function renderConf(confs) {
            const ctx = document.getElementById('confChart');
            if (confChart) confChart.destroy();
            if (!confs || !confs.length) return;
            const c = cConf();
            const bins = Array(20).fill(0);
            confs.forEach(v => bins[Math.min(Math.floor(v * 20), 19)]++);
            const labels = bins.map((_, i) => `${i * 5}-${(i + 1) * 5}%`);
            confChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels, datasets: [{
                        data: bins,
                        backgroundColor: bins.map((_, i) => i >= 10 ? 'rgba(239,68,68,0.45)' : 'rgba(34,197,94,0.45)'),
                        borderColor: bins.map((_, i) => i >= 10 ? '#ef4444' : '#22c55e'), borderWidth: 1, borderRadius: 3
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: c.text, font: { ...c.font, size: 9 }, maxRotation: 45 }, grid: { color: c.grid } },
                        y: { ticks: { color: c.text, font: c.font }, grid: { color: c.grid } }
                    }
                },
            });
        }

        function renderActivity(items) {
            const el = document.getElementById('activityList');
            if (!items.length) { el.innerHTML = '<div class="empty" style="padding:24px"><p>No activity yet</p></div>'; return; }
            el.innerHTML = items.map(a => {
                const isSpam = a.is_spam;
                const prob = Math.round(a.spam_probability * 100);
                const status = a.is_hidden ? 'ğŸ”´ Hidden' : (isSpam ? 'ğŸŸ¡ Flagged' : 'ğŸŸ¢ Safe');
                const text = a.text.length > 60 ? a.text.slice(0, 60) + '...' : a.text;
                return `<div class="activity-item">
            <span class="activity-dot ${isSpam ? 'dot-spam' : 'dot-safe'}"></span>
            <span class="activity-text"><strong>${a.author || 'User'}</strong>: ${escapeHtml(text)}</span>
            <span class="activity-prob" style="color:${isSpam ? 'var(--red)' : 'var(--green)'}">${prob}% ${status}</span>
        </div>`;
            }).join('');
        }

        function escapeHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

        loadThreshold();
        loadDash();
        setInterval(loadDash, 8000);
    </script>
</body>

</html>